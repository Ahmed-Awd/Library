# آلية الطلب

- 

من خلال واجهة صاحب المتجر (أو تطبيق صاحب المتجر) يضاف زر في الصفحة الرئيسية (طلب سائق)

و يقوم بعدها بملئ بيانات الطلب و هي:

| اسم الحقل | إلزامي؟   | الوصف |
| : |   :-   |  :  |
| الخريطة | نعم |خريطة وفيها يتم تحديد موقع الزبون   |
| رقم البناء | لا |رقم البناء أو المجمع الخاص  للزبون   |
| رقم الشقة | لا |رقم الشقة الخاص  للزبون   |
| الاسم  | لا |اسم العميل   |
| رقم هاتف | نعم |رقم هاتف خاص بالعميل   |
| المبلغ | نعم |المبلغ الاجمالى الخاص بالطلب   |
| وقت التسليم | نعم |وقت التسليم المتوقع افتراضي يكون بعد 10 دقائق من الوقت الحالي  |
| التعليق | لا |حقل نصي لكتابة تعليق للسائق  |


## آلية انشاء الطلب

![flow diaram يوضح آلية الطلب من جهة صاحب المتجر](/doc-files/v1.0/store_owner_order_flow.png)

الرسم السابق يوضح آلية إنشاء طلب من جهة صاحب المتجر سواء من التطبيق أو من لوحة التحكم، عمليات المعالجة الموضحة في الصورة تتم على السيرفر، وبعضها قد يتم في التطبيق وواجهة لوحة التحكم (Frontend) لتقليل الضغط على السيرفر، وفيما يلي توضيح للنقاط المرقمة في الرسم:

### 1- حساب المسافة باستخدام Google API
المسافة مهمة في تحديد سعر التوصيل وهي المسافة بين موقع المتجر المخزن في قاعدة البيانات، وموقع الزبون الذي تم ادخاله في بيانات الطلب،يتم حسابها باستخدام [Distance Matrix API](https://developers.google.com/maps/documentation/distance-matrix/overview)،
حساب المسافة يتم في الـ Backend حصرا لأنه ينبني عليه تحديد أسعار، فيتم قراءة المعلومات من جوجل من الباك اند منعا للتلاعب ويتم تخزين النتيجة في قاعدة البيانات لتقليل التكلفة وعدم حساب المسافة في كل مرة يتم قراءة بيانات الطلب فيها.

### 2- حساب سعر التوصيل ونسبة الخصم من الرصيد
<br>
#### سعر التوصيل
الجدول التالي يوضح طريقة حساب سعر التوصيل بناء على المسافة:

| المسافة | التسعير |
| : | :  |
| من 0 إلى 2 كم | 5 ليرة |
| أكثر من 2 كم | كل كيلو متر اضافي يضيف 3 ليرة إلى التسعير |

ويمكن التحكم بالتسعير من إعدادات الآدمن.

<br>

في حال كانت المسافة 2 كيلو أو أقل، يتم حساب التسعير الثابت الموضح في الجدول، أما في حال كانت المسافة أكبر من 2 كيلو متر، فيتم حسابها كالآتي:

على اعتبار المعطيات الآتية:   
<br>
distance = المسافة بالكيلو متر على اعتبار أن المسافة أكثر من 2 كيلو   
initialPrice = قيمة السعر الابتدائي الخاص وهي 5 ليرة في الجدول السابق   
additionalPrice = القيمة الإضافية وهي 3 ليرة بحسب الجدول السابق   
<br>
المعادلة التالية تمثل سعر التوصيل:   

<code>
initialPrice + additionalPrice*(distance-2)
</code>

<br>

#### نسبة الخصم من الرصيد
هي النسبة التي سيتم خصمها من الرصيد الخاص بصاحب المتجر وهي نسبة 25% من سعر التوصيل الذي تم توضيح طريقة حسابه بحسب الجدول السابق

### 4- إلغاء عملية الطلب
في حال كان رصيد صاحب المتجر لا يكفي ليتم خصم النسبة الخاصة بسمارت منه يتم تحويل حالة الطلب إلى "ملغي" وإظهار رسالة لصاحب المتجر لتوضيح سبب الإلغاء (عدم توفر رصيد).

### 5- حجز قيمة الرصيد من صاحب المتجر
عملية خصم الرصيد تتم بعد تحويل حالة الطلب إلى "تم التسليم" ولا يتم الخصم قبلها، لذلك يتم حجز قيمة الرصيد تجنبا لأي اخطاء في عملية التحقق من الرصيد في حال قام بطلب عدة طلبات

### 6- توليد رمز الـ QR
عند الطلب يتم تخزين رمز تحقق خاص بالطلب، في تطبيق صاحب المتجر يتم تحويل هذا الرمز إلى QR
بحيث يمكن للسائق من تطبيق السائق مسح الـ QR الموجود على تطبيق صاحب المتجر بحيث يتم التحقق من عملية استلام الطلب،
في حال تم مسح الـ QR بنجاح يتم تغيير حالة الطلب إلى "تحت التوصيل" هذه العملية تم تفصيلها في التعامل مع الطلب من جهة السائق""

### 7- إرسال الإشعار للسائقين
يتم إرسال إشعار للسائقين الموجودين في نفس المدينة بوجود طلب جديد، لا يتم إرسال اشعار للسائقين المسندين إلى طلبات غير مسلمة.

> {info} حاليا سيتم إشعار السائقين المسجلين في نفس المدينة، لاحقا عند برمجة نظام التتبع سيصبح ارسال الإشعار متعلقا بالمسافة


## التعامل مع الطلب من جهة السائق
هذا الرسم مكمل للرسم السابق، لكنه من وجهة نظر السائق

![flowdiagram يوضح آلية التعامل مع الطلب من جهة السائق](/doc-files/v1.0/driver_order_flow.png)

### 2- التحقق من الرصيد
يتم التحقق من ان السائق رصيده اكبر من القيمة الناتجة عن ضرب  نسبة الخصم  في سعر التوصيل  (هذه النسبة يتم ادخالها من قبل الادارة)
ويتم حجز القمية  من رصيد السائق مع الخصم 
 
### 3- التحقق من السائق ليس لديه طلبية سابقة 
التحقق من ان السائق ليس لديه طلبية سابقة  حالتها اما  السائق في الطريق الى المطعم او قيد التوصيل 
 

### 4- التحقق من توفر الطلب
بما أن الطلب يصل لأكثر من سائق في نفس الوقت، فيُحتمل وجود اكثر من سائق يضغط على الموافقة على الطلب في نفس اللحظة او بفاصل زمني قصير، لذلك يجب التحقق من توفر الطلب قبل إسناده لأي سائق، بحيث لا يتم إسناد الطلب لسائق قام بالموافقة بعد السائق الأول.

### 5- إدخال رمز الـ QR
تظهر للسائق شاشة مسح (scan) لرمز الـ QR الموجود على تطبيق صاحب المتجر، في حال عدم توفر امكانية للمسح يمكن ادخال الرمز كتابة في التطبيق.
كما هو موضح في الرسم، يمت التحقق من صحة الرمز وإعطاء 5 محاولات فقط (العدد قابل للتغيير حسب رأي فريق التطوير) بحيث لا تتم محاولة تخمين الرمز والتحايل في عملية استلام الطلب.


## حالات خاصة تحتاج معالجة

* اذا لم يتم قبول طلب من أي سائق بعد مدة معينة (يتم تحديدها من لوحة التحكم الادمن) يتم إلغاء الطلب تلقائيا وإرسال إشعار لصاحب المتجر وللوحة تحكم الادمن مع إرجاع الرصيد المحجوز
* في حال لم يتم تحديد حالة الطلب كـ "تم التسليم" في تطبيق السائق، يتم تحويلها تلقائيا بعد مدة يتم تحديدها في اعدادات الادمن""